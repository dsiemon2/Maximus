version: '3.8'

services:
  # ===========================================
  # Nginx Reverse Proxy - Port 8400
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: maximus_nginx
    ports:
      - "8400:80"
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./Maximus:/var/www/storefront:ro
      - ./maximus-backendadmin-api:/var/www/api:ro
    depends_on:
      - storefront
      - api
    networks:
      - maximus_network

  # ===========================================
  # Maximus - Customer Storefront
  # URL: http://localhost:8400/
  # ===========================================
  storefront:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: maximus_storefront
    volumes:
      - ./Maximus:/var/www/storefront
    environment:
      - DB_HOST=mysql
      - DB_DATABASE=maximus_petstore
      - DB_USERNAME=root
      - DB_PASSWORD=secret
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - maximus_network

  # ===========================================
  # API - REST Backend
  # URL: http://localhost:8400/api/
  # ===========================================
  api:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: maximus_api
    volumes:
      - ./maximus-backendadmin-api:/var/www/api
    environment:
      - DB_HOST=mysql
      - DB_DATABASE=maximus_petstore
      - DB_USERNAME=root
      - DB_PASSWORD=secret
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - maximus_network

  # ===========================================
  # Admin - Dashboard Site
  # URL: http://localhost:8401/adminpanel
  # ===========================================
  admin:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: maximus_admin
    volumes:
      - ./maximus-backend-admin-site:/var/www/admin
    environment:
      - DB_HOST=mysql
      - DB_DATABASE=maximus_petstore
      - DB_USERNAME=root
      - DB_PASSWORD=secret
      - API_BASE_URL=http://host.docker.internal:8400/api/v1
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - maximus_network

  # ===========================================
  # Nginx for Admin Panel (separate port 8401)
  # ===========================================
  nginx-admin:
    image: nginx:alpine
    container_name: maximus_nginx_admin
    ports:
      - "8401:80"
    volumes:
      - ./docker/nginx/admin.conf:/etc/nginx/conf.d/default.conf:ro
      - ./maximus-backend-admin-site:/var/www/admin:ro
    depends_on:
      - admin
    networks:
      - maximus_network

  # ===========================================
  # MySQL Database
  # Port: 3308 (external) -> 3306 (internal)
  # ===========================================
  mysql:
    image: mysql:8.0
    container_name: maximus_mysql
    ports:
      - "3308:3306"
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: maximus_petstore
    volumes:
      - maximus_mysql_data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-psecret"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - maximus_network

  # ===========================================
  # phpMyAdmin
  # URL: http://localhost:8480
  # ===========================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: maximus_phpmyadmin
    ports:
      - "8480:80"
    environment:
      PMA_HOST: mysql
      PMA_USER: root
      PMA_PASSWORD: secret
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - maximus_network

networks:
  maximus_network:
    driver: bridge

volumes:
  maximus_mysql_data:
    driver: local
